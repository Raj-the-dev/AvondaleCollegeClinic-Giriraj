@model AvondaleCollegeClinic.Models.Appointment
@{
    ViewData["Title"] = "Edit Appointment";
    bool lockStudent = ViewBag.LockStudent == true; // set in controller via PopulateStudentSelectAsync
    bool canEditStatus = User.IsInRole("Admin") || User.IsInRole("Doctor") || User.IsInRole("Teacher");
}

<section class="wrap page">
    <h1>@ViewData["Title"]</h1>

    <div asp-validation-summary="ModelOnly" class="validation-summary-errors"></div>

    <form asp-action="Edit" method="post">
        <input type="hidden" asp-for="AppointmentID" />

        <!-- Student -->
        <div class="form-row">
            <label asp-for="StudentID"></label>

            @if (lockStudent)
            {
                <select asp-for="StudentID"
                        class="input-line"
                        asp-items="ViewBag.StudentID"
                        disabled="disabled"></select>
                <input type="hidden" name="StudentID" value="@ViewBag.StudentID.SelectedValue" />
                <div class="hint">You are editing your own appointment.</div>
            }
            else
            {
                <select asp-for="StudentID" class="input-line" asp-items="ViewBag.StudentID"></select>
            }
            <span asp-validation-for="StudentID" class="error-summary"></span>
        </div>

        <!-- Doctor -->
        <div class="form-row">
            <label asp-for="DoctorID"></label>
            <select asp-for="DoctorID" id="DoctorID" class="input-line" asp-items="ViewBag.DoctorID"></select>
            <span asp-validation-for="DoctorID" class="error-summary"></span>
        </div>

        <!-- Hidden field so server receives the selected slot as AppointmentDateTime (ISO) -->
        <input asp-for="AppointmentDateTime" type="hidden" id="apptDateTimeHidden" />

        <!-- Date -->
        <div class="form-row">
            <label>Date</label>
            <select id="selectedDate" name="selectedDate" class="input-line" asp-items="ViewBag.DateOptions"></select>
            <small class="hint">Weekdays only, up to 30 days ahead.</small>
        </div>

        <!-- Time slot -->
        <div class="form-row">
            <label>Time slot</label>
            <select name="selectedSlot" id="selectedSlot" class="input-line" asp-items="ViewBag.Slots"></select>
            <span class="error-summary">@Html.ValidationMessage("AppointmentDateTime")</span>
        </div>

        <!-- Reason -->
        <div class="form-row">
            <label asp-for="Reason"></label>
            <input asp-for="Reason" class="input-line" />
            <span asp-validation-for="Reason" class="error-summary"></span>
        </div>

        <!-- Status (locked for Student/Caregiver) -->
        <div class="form-row">
            <label asp-for="Status"></label>
            @if (canEditStatus)
            {
                <select asp-for="Status" class="input-line" asp-items="Html.GetEnumSelectList<AppointmentStatus>()"></select>
            }
            else
            {
                <input type="text" class="input-line" value="@Model.Status" disabled />
                <input type="hidden" asp-for="Status" />
            }
            <span asp-validation-for="Status" class="error-summary"></span>
        </div>

        <div class="form-buttons">
            <button type="submit" class="btn">Save</button>
            <a asp-action="Index" class="link-quiet">Back to list</a>
        </div>
    </form>
</section>

@section Scripts {
    <script>
        async function loadSlots() {
            const doctorId = document.getElementById('DoctorID').value;
            const date = document.getElementById('selectedDate').value;
            const slotSel = document.getElementById('selectedSlot');
            slotSel.innerHTML = "";

            if (!doctorId || !date) return;

            const url = `@Url.Action("GetSlots", "Appointments")?doctorId=${encodeURIComponent(doctorId)}&date=${encodeURIComponent(date)}`;
            const res = await fetch(url, { cache: 'no-store' });
            const data = await res.json(); // [{value,text}, ...]

            data.forEach(x => {
                const opt = document.createElement('option');
                opt.value = x.value;
                opt.text = x.text;
                slotSel.appendChild(opt);
            });
        }

        document.getElementById('DoctorID').addEventListener('change', loadSlots);
        document.getElementById('selectedDate').addEventListener('change', loadSlots);

        // On submit, copy selectedSlot (ISO) into the hidden AppointmentDateTime field
        document.querySelector('form[asp-action="Edit"]')
            .addEventListener('submit', function () {
                document.getElementById('apptDateTimeHidden').value =
                    document.getElementById('selectedSlot').value || "";
            });
    </script>

    @await Html.PartialAsync("_ValidationScriptsPartial")
}
